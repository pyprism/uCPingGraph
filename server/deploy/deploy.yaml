---
# uCPingGraph – Unified Deployment Playbook
#
# Everything is driven by deploy_config.yaml — no separate hosts/inventory file needed.
#
# Usage:
#   1. Copy deploy_config.example.yaml → deploy_config.yaml and fill in values.
#   2. Run with tags:
#
#   Fresh systemd deployment (clone + build + install service):
#     ansible-playbook deploy.yaml -e @deploy_config.yaml --tags fresh
#
#   Update systemd deployment (pull + build + restart):
#     ansible-playbook deploy.yaml -e @deploy_config.yaml --tags update
#
#   Fresh Docker deployment (clone + docker compose up):
#     ansible-playbook deploy.yaml -e @deploy_config.yaml --tags docker-fresh
#
#   Update Docker deployment (pull + rebuild + restart containers):
#     ansible-playbook deploy.yaml -e @deploy_config.yaml --tags docker-update
#
#   Docker prune (clean unused images/containers):
#     ansible-playbook deploy.yaml -e @deploy_config.yaml --tags docker-prune

# ── Play 1: Build dynamic inventory from deploy_config.yaml ──────────────────
- hosts: localhost
  connection: local
  gather_facts: no
  tags: [always]

  vars:
    _repo_name: "{{ git_repo | basename | regex_replace('\\.git$', '') }}"
    _repo_dir: "{{ deploy_dir | regex_replace('/$', '') }}/{{ _repo_name }}"
    _server_dir: "{{ _repo_dir }}/server"

  tasks:
    - name: Build inventory from deploy_config.yaml
      add_host:
        name: "{{ ssh_host }}"
        groups: target
        ansible_user: "{{ ssh_user }}"
        ansible_port: "{{ ssh_port | default(22) }}"
        ansible_ssh_private_key_file: "{{ ssh_key_file | default(omit) }}"
        ansible_ssh_pass: "{{ ssh_pass | default(omit) }}"
        deploy_dir: "{{ deploy_dir }}"
        repo_dir: "{{ _repo_dir }}"
        server_dir: "{{ _server_dir }}"
        go_bin_path: "{{ go_bin_path }}"
        git_repo: "{{ git_repo }}"
        git_branch: "{{ git_branch | default('master') }}"
        git_token: "{{ git_token | default('') }}"
        service_name: "{{ service_name | default('ucpinggraph') }}"
        binary_name: "{{ binary_name | default('uCPingGraph') }}"
        docker_compose_file: "{{ docker_compose_file | default('docker-compose.production.yaml') }}"
        env_vars: "{{ env_vars | default({}) }}"

# ── Play 2: Run deployment on the target server ─────────────────────────────
- hosts: target
  become: yes
  become_user: "{{ ansible_user }}"
  become_flags: "-E"
  gather_facts: yes

  vars:
    _git_url: >-
      {% if git_token | default('') | length > 0 -%}
        https://{{ git_token }}@{{ git_repo | regex_replace('^https?://', '') }}
      {%- else -%}
        {{ git_repo }}
      {%- endif %}

  tasks:
    # ─────────────────────────────────────────────────────────────────────────
    #  FRESH DEPLOYMENT (systemd) – clone, build, install service, start
    # ─────────────────────────────────────────────────────────────────────────

    - name: "[fresh] Ensure deploy parent directory exists"
      file:
        path: "{{ deploy_dir }}"
        state: directory
        owner: "{{ ansible_user }}"
        mode: "0755"
      tags: [fresh]

    - name: "[fresh] Check if repo is already cloned"
      stat:
        path: "{{ repo_dir }}/.git"
      register: _git_dir_fresh
      tags: [fresh]

    - name: "[fresh] Clone repository"
      git:
        repo: "{{ _git_url }}"
        dest: "{{ repo_dir }}"
        version: "{{ git_branch }}"
        update: no
      when: not _git_dir_fresh.stat.exists
      tags: [fresh]

    - name: "[fresh] Pull latest (repo already existed)"
      git:
        repo: "{{ _git_url }}"
        dest: "{{ repo_dir }}"
        version: "{{ git_branch }}"
        update: yes
        force: yes
      when: _git_dir_fresh.stat.exists
      tags: [fresh]

    - name: "[fresh] Create required directories"
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        mode: "0755"
      loop:
        - "{{ server_dir }}/storage/db"
        - "{{ server_dir }}/logs"
      tags: [fresh]

    - name: "[fresh] Write .env file"
      copy:
        dest: "{{ server_dir }}/.env"
        content: |
          {% for key, value in env_vars.items() %}
          {{ key }}={{ value }}
          {% endfor %}
        owner: "{{ ansible_user }}"
        mode: "0600"
      when: env_vars | length > 0
      tags: [fresh]

    - name: "[fresh] Download Go modules"
      command: go mod download
      args:
        chdir: "{{ server_dir }}"
      environment:
        PATH: "{{ go_bin_path }}:{{ ansible_env.PATH }}"
        HOME: "/home/{{ ansible_user }}"
      tags: [fresh]

    - name: "[fresh] Build binary"
      command: go build -o {{ binary_name }} .
      args:
        chdir: "{{ server_dir }}"
      environment:
        PATH: "{{ go_bin_path }}:{{ ansible_env.PATH }}"
        HOME: "/home/{{ ansible_user }}"
        CGO_ENABLED: "1"
      tags: [fresh]

    - name: "[fresh] Install systemd service"
      become_user: root
      template:
        src: systemd/ucpinggraph.service
        dest: /etc/systemd/system/{{ service_name }}.service
        mode: "0644"
      tags: [fresh]

    - name: "[fresh] Reload systemd daemon"
      become_user: root
      systemd:
        daemon_reload: yes
      tags: [fresh]

    - name: "[fresh] Enable and start service"
      become_user: root
      systemd:
        name: "{{ service_name }}"
        enabled: yes
        state: started
      tags: [fresh]

    # ─────────────────────────────────────────────────────────────────────────
    #  UPDATE DEPLOYMENT (systemd) – pull, build, restart
    # ─────────────────────────────────────────────────────────────────────────

    - name: "[update] Pull latest changes"
      git:
        repo: "{{ _git_url }}"
        dest: "{{ repo_dir }}"
        version: "{{ git_branch }}"
        update: yes
        force: yes
      tags: [update]

    - name: "[update] Write .env file"
      copy:
        dest: "{{ server_dir }}/.env"
        content: |
          {% for key, value in env_vars.items() %}
          {{ key }}={{ value }}
          {% endfor %}
        owner: "{{ ansible_user }}"
        mode: "0600"
      when: env_vars | length > 0
      tags: [update]

    - name: "[update] Create required directories"
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        mode: "0755"
      loop:
        - "{{ server_dir }}/storage/db"
        - "{{ server_dir }}/logs"
      tags: [update]

    - name: "[update] Download Go modules"
      command: go mod download
      args:
        chdir: "{{ server_dir }}"
      environment:
        PATH: "{{ go_bin_path }}:{{ ansible_env.PATH }}"
        HOME: "/home/{{ ansible_user }}"
      tags: [update]

    - name: "[update] Build binary"
      command: go build -o {{ binary_name }} .
      args:
        chdir: "{{ server_dir }}"
      environment:
        PATH: "{{ go_bin_path }}:{{ ansible_env.PATH }}"
        HOME: "/home/{{ ansible_user }}"
        CGO_ENABLED: "1"
      tags: [update]

    - name: "[update] Restart systemd service"
      become_user: root
      systemd:
        name: "{{ service_name }}"
        state: restarted
      tags: [update]

    # ─────────────────────────────────────────────────────────────────────────
    #  FRESH DOCKER DEPLOYMENT – clone, docker compose up
    # ─────────────────────────────────────────────────────────────────────────

    - name: "[docker-fresh] Ensure deploy parent directory exists"
      file:
        path: "{{ deploy_dir }}"
        state: directory
        owner: "{{ ansible_user }}"
        mode: "0755"
      tags: [docker-fresh]

    - name: "[docker-fresh] Check if repo is already cloned"
      stat:
        path: "{{ repo_dir }}/.git"
      register: _git_dir_docker_fresh
      tags: [docker-fresh]

    - name: "[docker-fresh] Clone repository"
      git:
        repo: "{{ _git_url }}"
        dest: "{{ repo_dir }}"
        version: "{{ git_branch }}"
        update: no
      when: not _git_dir_docker_fresh.stat.exists
      tags: [docker-fresh]

    - name: "[docker-fresh] Pull latest (repo already existed)"
      git:
        repo: "{{ _git_url }}"
        dest: "{{ repo_dir }}"
        version: "{{ git_branch }}"
        update: yes
        force: yes
      when: _git_dir_docker_fresh.stat.exists
      tags: [docker-fresh]

    - name: "[docker-fresh] Create required directories"
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        mode: "0755"
      loop:
        - "{{ server_dir }}/storage/db"
        - "{{ server_dir }}/logs"
      tags: [docker-fresh]

    - name: "[docker-fresh] Write .env file"
      copy:
        dest: "{{ server_dir }}/.env"
        content: |
          {% for key, value in env_vars.items() %}
          {{ key }}={{ value }}
          {% endfor %}
        owner: "{{ ansible_user }}"
        mode: "0600"
      when: env_vars | length > 0
      tags: [docker-fresh]

    - name: "[docker-fresh] Build and start containers"
      command: docker compose -f {{ docker_compose_file }} up --build -d
      args:
        chdir: "{{ server_dir }}"
      tags: [docker-fresh]

    # ─────────────────────────────────────────────────────────────────────────
    #  UPDATE DOCKER DEPLOYMENT – pull, rebuild, restart containers
    # ─────────────────────────────────────────────────────────────────────────

    - name: "[docker-update] Pull latest changes"
      git:
        repo: "{{ _git_url }}"
        dest: "{{ repo_dir }}"
        version: "{{ git_branch }}"
        update: yes
        force: yes
      tags: [docker-update]

    - name: "[docker-update] Write .env file"
      copy:
        dest: "{{ server_dir }}/.env"
        content: |
          {% for key, value in env_vars.items() %}
          {{ key }}={{ value }}
          {% endfor %}
        owner: "{{ ansible_user }}"
        mode: "0600"
      when: env_vars | length > 0
      tags: [docker-update]

    - name: "[docker-update] Stop running containers"
      command: docker compose -f {{ docker_compose_file }} down
      args:
        chdir: "{{ server_dir }}"
      tags: [docker-update]

    - name: "[docker-update] Rebuild and start containers"
      command: docker compose -f {{ docker_compose_file }} up --force-recreate --build -d
      args:
        chdir: "{{ server_dir }}"
      tags: [docker-update]

    # ─────────────────────────────────────────────────────────────────────────
    #  DOCKER PRUNE – clean unused images, containers, volumes
    # ─────────────────────────────────────────────────────────────────────────

    - name: "[docker-prune] Prune unused Docker resources"
      command: docker system prune -a -f
      tags: [docker-prune]

